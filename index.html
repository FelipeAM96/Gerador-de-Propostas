<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Proposta Comercial</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 900px;
        }
        input[type="text"], input[type="date"], input[type="number"], select, textarea {
            @apply w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-200;
        }
        button {
            @apply px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200;
        }
        .section-title {
            @apply text-xl font-semibold text-gray-800 mb-4;
        }
        .image-preview {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin-top: 10px;
        }
        .output-area {
            @apply bg-white p-6 rounded-lg shadow-lg border border-gray-200 overflow-auto;
            min-height: 200px;
            white-space: pre-wrap; /* Preserve whitespace and wrap text */
            word-wrap: break-word; /* Break long words */
            line-height: 1.5; /* Adjusted for better readability */
        }
        .paste-zone {
            @apply flex items-center justify-center h-24 border-2 border-dashed border-gray-300 rounded-lg text-gray-500 cursor-pointer;
            transition: border-color 0.2s ease-in-out;
        }
        .paste-zone.has-image {
            @apply border-green-500 text-green-700;
        }
        .paste-zone:hover {
            @apply border-blue-500;
        }

        /* Estilos para o modal customizado */
        .modal {
            transition: opacity 0.3s ease-in-out;
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8 lg:p-10 flex justify-center items-start min-h-screen">
    <div class="container bg-white p-6 sm:p-8 md:p-10 rounded-xl shadow-2xl space-y-8">
        <h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-900 mb-8">Gerador de Proposta Comercial de Imagens de Sat√©lite</h1>

        <!-- Se√ß√£o de Dados da Proposta -->
        <div class="space-y-6">
            <h2 class="section-title">Dados da Proposta</h2>
            <div>
                <label for="dataProposta" class="block text-gray-700 text-sm font-medium mb-2">Data da Proposta:</label>
                <input type="date" id="dataProposta" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="empresaCliente" class="block text-gray-700 text-sm font-medium mb-2">Empresa Cliente:</label>
                <input type="text" id="empresaCliente" placeholder="Nome da Empresa" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="contatoCliente" class="block text-gray-700 text-sm font-medium mb-2">Contato Cliente:</label>
                <input type="text" id="contatoCliente" placeholder="Nome do Contato" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="cpfCliente" class="block text-gray-700 text-sm font-medium mb-2">CPF/CNPJ Cliente:</label>
                <input type="text" id="cpfCliente" placeholder="CPF ou CNPJ do Cliente" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="enderecoCliente" class="block text-gray-700 text-sm font-medium mb-2">Endere√ßo Cliente:</label>
                <input type="text" id="enderecoCliente" placeholder="Endere√ßo completo do Cliente" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="processoVinculado" class="block text-gray-700 text-sm font-medium mb-2">Processo Vinculado:</label>
                <input type="text" id="processoVinculado" placeholder="N√∫mero do processo vinculado" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="extensaoArea" class="block text-gray-700 text-sm font-medium mb-2">Extens√£o da √Årea (km¬≤):</label>
                <input type="number" id="extensaoArea" placeholder="Ex: 100" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="dataImageamentoInicio" class="block text-gray-700 text-sm font-medium mb-2">Data de Imageamento In√≠cio:</label>
                <input type="date" id="dataImageamentoInicio" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="dataImageamentoFim" class="block text-gray-700 text-sm font-medium mb-2">Data de Imageamento Fim:</label>
                <input type="date" id="dataImageamentoFim" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="cenaRecomendada" class="block text-gray-700 text-sm font-medium mb-2">Cena Recomendada:</label>
                <input type="text" id="cenaRecomendada" placeholder="Ex: Cena 12345" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="resolucaoColorida" class="block text-gray-700 text-sm font-medium mb-2">Resolu√ß√£o Colorida:</label>
                <input type="text" id="resolucaoColorida" placeholder="Ex: 0.5m" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="dataCenaRecomendada" class="block text-gray-700 text-sm font-medium mb-2">Data(s) da Cena Recomendada (separadas por v√≠rgula):</label>
                <input type="text" id="dataCenaRecomendada" placeholder="Ex: 15/06/2024, 20/07/2024" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="sateliteOpcoes" class="block text-gray-700 text-sm font-medium mb-2">Sat√©lite(s) (Op√ß√µes - Ctrl+clique para m√∫ltiplos):</label>
                <select id="sateliteOpcoes" multiple size="5" class="w-full p-3 border border-gray-300 rounded-lg">
                    <option value="WorldView 2">WorldView 2</option>
                    <option value="WorldView 3">WorldView 3</option>
                    <option value="Pleiades">Pleiades</option>
                    <option value="Pleiades Neo">Pleiades Neo</option>
                    <option value="Jilin">Jilin</option>
                    <option value="Sentinel-2">Sentinel-2</option>
                    <option value="Landsat 8">Landsat 8</option>
                </select>
            </div>
            <div id="sateliteLinkOutput" class="text-blue-600 text-sm mt-2" style="display: none;"></div>

            <div>
                <label for="pedidoMinimoKm2" class="block text-gray-700 text-sm font-medium mb-2">Pedido M√≠nimo (Km¬≤):</label>
                <input type="number" id="pedidoMinimoKm2" placeholder="Ex: 50" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="custoRs" class="block text-gray-700 text-sm font-medium mb-2">Custo (R$):</label>
                <input type="number" id="custoRs" placeholder="Ex: 15000" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
            <div>
                <label for="diasEntrega" class="block text-gray-700 text-sm font-medium mb-2">Entrega (dias):</label>
                <input type="number" id="diasEntrega" placeholder="Ex: 7" class="w-full p-3 border border-gray-300 rounded-lg">
            </div>
        </div>

        <!-- Se√ß√£o de Imagens -->
        <div class="space-y-6">
            <h2 class="section-title">Adicionar Imagens (Cole com Ctrl+V)</h2>
            <p class="text-sm text-gray-600 mb-4">As imagens ser√£o redimensionadas automaticamente para se ajustarem ao documento, mantendo a propor√ß√£o.</p>
            <div id="imageInputs" class="space-y-4">
                <!-- Imagem 1: √Årea de Interesse (Initial image block) -->
                <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                    <label class="block text-gray-700 text-sm font-medium mb-2">√Årea para Colar Imagem 1 (√Årea de Interesse):</label>
                    <div id="pasteZone1" class="paste-zone" tabindex="0">Cole sua imagem aqui (Ctrl+V)</div>
                    <input type="hidden" id="hiddenImageData1" data-image-pasted="false">
                    <label for="imageCaption1" class="block text-gray-700 text-sm font-medium mt-4 mb-2">Legenda da Imagem 1 (Figura 1 - √Årea de interesse com informa√ß√£o de metragem.):</label>
                    <input type="text" id="imageCaption1" value="Figura 1 - √Årea de interesse com informa√ß√£o de metragem." placeholder="Legenda descritiva para a imagem">
                    <img id="imagePreview1" class="image-preview hidden" alt="Pr√©-visualiza√ß√£o da Imagem 1">
                    <button type="button" class="clear-image-btn mt-2 px-4 py-2 bg-red-500 text-white text-sm rounded-md hover:bg-red-600" data-target-id="1">Limpar Imagem 1</button>
                </div>
            </div>
            <div class="flex flex-col sm:flex-row gap-4 mt-4">
                <button id="addOneImageBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg py-3 sm:w-1/2">Adicionar outra imagem</button>
                <button id="addMultipleImagesBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold rounded-lg py-3 sm:w-1/2">Adicionar mais 5 imagens</button>
            </div>
        </div>

        <!-- Bot√£o Gerar Pr√©-visualiza√ß√£o -->
        <button id="generatePreviewBtn" class="w-full px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition duration-200;">Gerar Pr√©-visualiza√ß√£o</button>

        <!-- Se√ß√£o de Pr√©-visualiza√ß√£o -->
        <div class="space-y-6">
            <h2 class="section-title">Pr√©-visualiza√ß√£o da Proposta</h2>
            <div id="previewOutput" class="output-area">
                <p class="text-gray-500">A pr√©-visualiza√ß√£o da sua proposta aparecer√° aqui.</p>
            </div>
            <div class="mt-4">
                <label for="docxFilename" class="block text-gray-700 text-sm font-medium mb-2">Nome do arquivo DOCX:</label>
                <input type="text" id="docxFilename" value="Proposta Comercial de Imagens de Sat√©lite" class="w-full p-3 border border-gray-300 rounded-lg mb-4">
            </div>
            <div class="flex flex-col sm:flex-row gap-4 mt-4">
                <button id="downloadDocxBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold rounded-lg py-3">Baixar como .DOCX</button>
            </div>
        </div>

        <p class="text-center text-sm text-gray-600 mt-8">
            <strong>Nota:</strong> Este gerador cria conte√∫do em HTML. Para obter um arquivo .docx com formata√ß√£o mais consistente, clique em "Baixar como .DOCX". As imagens coladas ser√£o incorporadas diretamente no HTML.
            <br/><br/>
            **Aten√ß√£o:** As quebras de p√°gina s√£o sugest√µes e podem variar dependendo do editor de texto e das configura√ß√µes de impress√£o.
        </p>
    </div>

    <!-- Custom Alert Modal -->
    <div id="customAlertModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden modal">
        <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full text-center">
            <p id="customAlertMessage" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="customAlertCloseBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">OK</button>
        </div>
    </div>

    <!-- Exportar HTML como .docx -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html-docx-js@0.3.0/dist/html-docx.min.js"></script>

    <script>
        window.onload = () => {
            // Vari√°vel para controlar o n√∫mero de imagens
            let currentImageCount = 1;
            const MAX_IMAGES = 15;

            // Fun√ß√£o para exibir o modal customizado
            function showCustomAlert(message) {
                document.getElementById('customAlertMessage').textContent = message;
                document.getElementById('customAlertModal').classList.remove('hidden');
            }

            // Event listener para fechar o modal
            document.getElementById('customAlertCloseBtn').addEventListener('click', () => {
                document.getElementById('customAlertModal').classList.add('hidden');
            });

            // Objeto para mapear op√ß√µes de sat√©lite para URLs
            const satelliteLinks = {
                "WorldView 2": "https://www.engesat.com.br/imagem-de-satelite/world-view-2/",
                "WorldView 3": "https://www.engesat.com.br/imagem-de-satelite/world-view-3/",
                "Pleiades": "https://www.engesat.com.br/imagem-de-satelite/pleiades/",
                "Pleiades Neo": "https://www.engesat.com.br/imagem-de-satelite/pleiades-neo/",
                "Jilin": "https://www.engesat.com.br/imagem-de-satelite/jilin-1/",
                "Sentinel-2": "https://www.esa.int/Applications/Observing_the_Earth/Copernicus/Sentinel-2",
                "Landsat 8": "https://landsat.gsfc.nasa.gov/landsat-8/"
            };

            // Event listener para o select de sat√©lites
            document.getElementById('sateliteOpcoes').addEventListener('change', () => {
                const selectedSatellites = Array.from(document.getElementById('sateliteOpcoes').selectedOptions).map(option => option.value);
                const linkOutput = document.getElementById('sateliteLinkOutput');
                let linksHtml = '';
                if (selectedSatellites.length > 0) {
                    linksHtml += 'Links dos Sat√©lites Selecionados:<br>';
                    selectedSatellites.forEach(sat => {
                        const link = satelliteLinks[sat];
                        if (link) {
                            linksHtml += `<a href="${link}" target="_blank" style="color: #2563eb; text-decoration: underline;">${sat}: ${link}</a><br>`;
                        }
                    });
                    linkOutput.innerHTML = linksHtml;
                    linkOutput.style.display = 'block';
                } else {
                    linkOutput.innerHTML = '';
                    linkOutput.style.display = 'none';
                }
            });

            // Fun√ß√£o para lidar com a colagem de imagens
            function handleImagePaste(event, pasteZoneId, hiddenInputId, previewImgId) {
                event.preventDefault();

                const items = (event.clipboardData || event.originalEvent.clipboardData).items;
                let imageFound = false;

                for (const item of items) {
                    if (item.kind === 'file' && item.type.startsWith('image/')) {
                        const file = item.getAsFile();
                        const reader = new FileReader();

                        reader.onload = (e) => {
                            const imageDataUrl = e.target.result;
                            const pasteZone = document.getElementById(pasteZoneId);
                            const hiddenInput = document.getElementById(hiddenInputId);
                            const previewImg = document.getElementById(previewImgId);

                            hiddenInput.value = imageDataUrl;
                            hiddenInput.setAttribute('data-image-pasted', 'true');

                            previewImg.src = imageDataUrl;
                            previewImg.classList.remove('hidden');

                            pasteZone.textContent = 'Imagem colada com sucesso!';
                            pasteZone.classList.add('has-image');
                        };
                        reader.readAsDataURL(file);
                        imageFound = true;
                        break;
                    }
                }

                if (!imageFound) {
                    const pasteZone = document.getElementById(pasteZoneId);
                    const pastedText = (event.clipboardData || window.clipboardData).getData('text');
                    if (pastedText) {
                        pasteZone.textContent = pastedText.substring(0, 50) + (pastedText.length > 50 ? '...' : '');
                        pasteZone.classList.remove('has-image');
                        const hiddenInput = document.getElementById(hiddenInputId);
                        hiddenInput.value = '';
                        hiddenInput.setAttribute('data-image-pasted', 'false');
                        document.getElementById(previewImgId).classList.add('hidden');
                    } else {
                        pasteZone.textContent = 'Nenhuma imagem ou texto v√°lido colado.';
                        pasteZone.classList.remove('has-image');
                    }
                }
            }

            // Fun√ß√£o para limpar a imagem colada
            function clearImage(id) {
                const pasteZone = document.getElementById(`pasteZone${id}`);
                const hiddenInput = document.getElementById(`hiddenImageData${id}`);
                const previewImg = document.getElementById(`imagePreview${id}`);
                const imageCaption = document.getElementById(`imageCaption${id}`);
                const imageSat = document.getElementById(`image${id}Sat`);
                const imageDate = document.getElementById(`image${id}Date`);
                const imageRes = document.getElementById(`image${id}Res`);


                pasteZone.textContent = 'Cole sua imagem aqui (Ctrl+V)';
                pasteZone.classList.remove('has-image');
                hiddenInput.value = '';
                hiddenInput.setAttribute('data-image-pasted', 'false');
                previewImg.src = '';
                previewImg.classList.add('hidden');

                if (id === 1) {
                    imageCaption.value = "Figura 1 - √Årea de interesse com informa√ß√£o de metragem.";
                } else {
                    imageCaption.value = `Figura ${id} ‚Äì Imagem de sat√©lite Quick Look em cat√°logo.`;
                }

                if (imageSat) imageSat.value = '';
                if (imageDate) imageDate.value = '';
                if (imageRes) imageRes.value = '';
            }

            // Fun√ß√£o para adicionar um novo bloco de imagem
            function addImageInput(numToAdd = 1) {
                const imageInputsContainer = document.getElementById('imageInputs');
                for (let k = 0; k < numToAdd; k++) {
                    if (currentImageCount >= MAX_IMAGES) {
                        showCustomAlert(`Limite m√°ximo de ${MAX_IMAGES} imagens atingido.`);
                        return;
                    }
                    currentImageCount++;
                    const newImageBlock = document.createElement('div');
                    newImageBlock.className = 'p-4 border border-gray-200 rounded-lg bg-gray-50';
                    newImageBlock.innerHTML = `
                        <label class="block text-gray-700 text-sm font-medium mb-2">√Årea para Colar Imagem ${currentImageCount}:</label>
                        <div id="pasteZone${currentImageCount}" class="paste-zone" tabindex="0">Cole sua imagem aqui (Ctrl+V)</div>
                        <input type="hidden" id="hiddenImageData${currentImageCount}" data-image-pasted="false">
                        <label for="imageCaption${currentImageCount}" class="block text-gray-700 text-sm font-medium mt-4 mb-2">Legenda da Imagem ${currentImageCount} (Figura ${currentImageCount} ‚Äì Imagem de sat√©lite Quick Look em cat√°logo.):</label>
                        <input type="text" id="imageCaption${currentImageCount}" value="Figura ${currentImageCount} ‚Äì Imagem de sat√©lite Quick Look em cat√°logo." placeholder="Legenda descritiva para a imagem">
                        <label for="image${currentImageCount}Sat" class="block text-gray-700 text-sm font-medium mt-2 mb-2">Sat√©lite (Imagem ${currentImageCount}):</label>
                        <input type="text" id="image${currentImageCount}Sat" placeholder="Ex: WorldView 3">
                        <label for="image${currentImageCount}Date" class="block text-gray-700 text-sm font-medium mt-2 mb-2">Data (Imagem ${currentImageCount}):</label>
                        <input type="text" id="image${currentImageCount}Date" placeholder="Ex: 01/01/2024">
                        <label for="image${currentImageCount}Res" class="block text-gray-700 text-sm font-medium mt-2 mb-2">Resolu√ß√£o (Imagem ${currentImageCount}):</label>
                        <input type="text" id="image${currentImageCount}Res" placeholder="Ex: 0.5m">
                        <img id="imagePreview${currentImageCount}" class="image-preview hidden" alt="Pr√©-visualiza√ß√£o da Imagem ${currentImageCount}">
                        <button type="button" class="clear-image-btn mt-2 px-4 py-2 bg-red-500 text-white text-sm rounded-md hover:bg-red-600" data-target-id="${currentImageCount}">Limpar Imagem ${currentImageCount}</button>
                    `;
                    imageInputsContainer.appendChild(newImageBlock);

                    // Add event listeners to the newly created elements
                    document.getElementById(`pasteZone${currentImageCount}`).addEventListener('paste', (e) => handleImagePaste(e, `pasteZone${currentImageCount}`, `hiddenImageData${currentImageCount}`, `imagePreview${currentImageCount}`));
                    document.querySelector(`.clear-image-btn[data-target-id="${currentImageCount}"]`).addEventListener('click', (e) => {
                        const targetId = e.target.dataset.targetId;
                        clearImage(targetId);
                    });
                }
            }

            // Add event listeners for the new buttons
            document.getElementById('addOneImageBtn').addEventListener('click', () => addImageInput(1));
            document.getElementById('addMultipleImagesBtn').addEventListener('click', () => addImageInput(5));


            // Add listeners for the initial image block
            document.getElementById(`pasteZone1`).addEventListener('paste', (e) => handleImagePaste(e, `pasteZone1`, `hiddenImageData1`, `imagePreview1`));
            document.querySelector(`.clear-image-btn[data-target-id="1"]`).addEventListener('click', (e) => {
                const targetId = e.target.dataset.targetId;
                clearImage(targetId);
            });


            // Fun√ß√£o para formatar a data de ISO (YYYY-MM-DD) para DD/MM/YYYY ou manter DD/MM/YYYY
            function formatarData(dateString) {
                if (!dateString) return '';
                dateString = dateString.trim();
                // Check if it's already in DD/MM/YYYY format
                if (dateString.match(/^\d{2}\/\d{2}\/\d{4}$/)) {
                    return dateString;
                }
                // Assume ISO (YYYY-MM-DD) for conversion
                const [year, month, day] = dateString.split('-');
                if (year && month && day) {
                    return `${day}/${month}/${year}`;
                }
                return ''; // Return empty if format is unrecognized
            }

            document.getElementById('generatePreviewBtn').addEventListener('click', () => {
                const dataProposta = formatarData(document.getElementById('dataProposta').value);
                const empresaCliente = document.getElementById('empresaCliente').value;
                const contatoCliente = document.getElementById('contatoCliente').value;
                const cpfCliente = document.getElementById('cpfCliente').value;
                const enderecoCliente = document.getElementById('enderecoCliente').value;
                const processoVinculado = document.getElementById('processoVinculado').value;
                const extensaoArea = document.getElementById('extensaoArea').value;
                const dataImageamentoInicio = formatarData(document.getElementById('dataImageamentoInicio').value);
                const dataImageamentoFim = formatarData(document.getElementById('dataImageamentoFim').value);
                const cenaRecomendada = document.getElementById('cenaRecomendada').value;
                const resolucaoColorida = document.getElementById('resolucaoColorida').value;

                // Processa m√∫ltiplas datas da cena recomendada
                const dataCenaRecomendadaInput = document.getElementById('dataCenaRecomendada').value;
                const formattedCenaDates = dataCenaRecomendadaInput.split(',').map(dateStr => formatarData(dateStr.trim())).filter(Boolean).join(', ');

                // Processa m√∫ltiplos sat√©lites e constr√≥i a se√ß√£o de amostras
                const selectedSatellites = Array.from(document.getElementById('sateliteOpcoes').selectedOptions).map(option => option.value);
                let samplesHtml = '';
                if (selectedSatellites.length > 0) {
                    samplesHtml += `
                        <h4 style="margin-top: 16px; margin-bottom: 8px; font-size: 1em; font-weight: 500; color: #374151;">Amostras das Imagens de Sat√©lite:</h4>
                        <ul style="list-style-type: disc; margin-left: 20px; margin-bottom: 16px;">
                    `;
                    selectedSatellites.forEach(sat => {
                        const link = satelliteLinks[sat];
                        if (link) {
                            samplesHtml += `<li style="margin-bottom: 4px;"><strong>${sat}:</strong> <a href="${link}" target="_blank" style="color: #2563eb; text-decoration: underline;">${link}</a></li>`;
                        } else {
                            samplesHtml += `<li style="margin-bottom: 4px;"><strong>${sat}</strong></li>`;
                        }
                    });
                    samplesHtml += `</ul>`;
                }


                const pedidoMinimoKm2 = document.getElementById('pedidoMinimoKm2').value;
                const custoRs = parseFloat(document.getElementById('custoRs').value).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) || '####';
                const diasEntrega = document.getElementById('diasEntrega').value;

                const previewOutput = document.getElementById('previewOutput');
                const downloadDocxBtn = document.getElementById('downloadDocxBtn');

                // Define as dimens√µes m√°ximas para as imagens no DOCX em cm
                const MAX_PAGE_IMAGE_WIDTH_CM = 15; // Largura m√°xima em cm
                const MAX_PAGE_IMAGE_HEIGHT_CM = 8.45; // Altura m√°xima em cm

                let imagesHtmlFigura1 = '';
                let imagesHtmlFigurasAlternativas = '';

                for (let i = 1; i <= currentImageCount; i++) {
                    const hiddenInput = document.getElementById(`hiddenImageData${i}`);
                    // Check if the element exists (for dynamically added images)
                    if (!hiddenInput) continue;

                    const imageDataUrl = hiddenInput.value;
                    const imageCaption = document.getElementById(`imageCaption${i}`).value;

                    // Novos campos de detalhes da imagem
                    const imageSat = document.getElementById(`image${i}Sat`) ? document.getElementById(`image${i}Sat`).value : '';
                    const imageDate = document.getElementById(`image${i}Date`) ? document.getElementById(`image${i}Date`).value : '';
                    const imageRes = document.getElementById(`image${i}Res`) ? document.getElementById(`image${i}Res`).value : '';

                    // Always use max-width and auto height
                    let imageStyle = `max-width: ${MAX_PAGE_IMAGE_WIDTH_CM}cm; height: auto; border-radius: 8px; display: block; margin: 0 auto;`;

                    if (imageDataUrl && hiddenInput.getAttribute('data-image-pasted') === 'true') {
                        let imageBlock = `
                            <div style="margin-bottom: 20px; text-align: center; page-break-inside: avoid;">
                        `;
                        // Adiciona os novos detalhes da imagem se existirem e n√£o for a Figura 1
                        if (i !== 1) {
                            if (imageSat) imageBlock += `<p style="font-size: 0.85em; color: #666; margin: 0;"><strong>Sat√©lite:</strong> ${imageSat}</p>`;
                            if (imageDate) imageBlock += `<p style="font-size: 0.85em; color: #666; margin: 0;"><strong>Data:</strong> ${imageDate}</p>`;
                            if (imageRes) imageBlock += `<p style="font-size: 0.85em; color: #666; margin: 0 0 5px 0;"><strong>Resolu√ß√£o:</strong> ${imageRes}</p>`;
                        }
                        imageBlock += `
                                <img src="${imageDataUrl}" alt="${imageCaption || 'Imagem do Documento'}" style="${imageStyle}">
                                ${imageCaption ? `<p style="font-size: 0.9em; text-align: center; color: #555; margin-top: 8px; font-style: italic;">${imageCaption}</p>` : ''}
                            </div>
                        `;

                        if (i === 1) {
                            imagesHtmlFigura1 = imageBlock;
                        } else {
                            imagesHtmlFigurasAlternativas += imageBlock;
                        }
                    }
                }

                // Conte√∫do das Especifica√ß√µes T√©cnicas
                const especificacoesTecnicasHtml = `
                    <h4 style="margin-top: 16px; margin-bottom: 8px; font-size: 1em; font-weight: 500; color: #374151;">Especifica√ß√µes T√©cnicas das Imagens:</h4>
                    <ul style="list-style-type: disc; margin-left: 20px; margin-bottom: 16px;">
                        <li style="margin-bottom: 4px;">Ortoretificada</li>
                        <li style="margin-bottom: 4px;">Sistema de coordenadas UTM Sirgas 2000</li>
                        <li style="margin-bottom: 4px;">Formato GeoTIFF, com 3 ou 4 bandas</li>
                    </ul>
                `;

                // Conte√∫do dos Detalhes do Pedido
                const detalhesPedidoHtml = `
                    <h4 style="margin-top: 16px; margin-bottom: 8px; font-size: 1em; font-weight: 500; color: #374151;">Detalhes do Pedido</h4>
                    <ul style="list-style-type: disc; margin-left: 20px; margin-bottom: 16px;">
                        <li style="margin-bottom: 4px;">Pedido m√≠nimo de ${pedidoMinimoKm2} Km2</li>
                        <li style="margin-bottom: 4px;">Custo de R$ ${custoRs}</li>
                        <li style="margin-bottom: 4px;">Entrega em ${diasEntrega} dias</li>
                        <li style="margin-bottom: 4px;">Pagamento na confirma√ß√£o do pedido</li>
                    </ul>
                `;

                // Texto sobre visualiza√ß√£o preliminar
                const quickLookDisclaimer = `
                    <p style="margin-bottom: 16px;">As ilustra√ß√µes acima s√£o <span style="color: red; font-weight: bold;">visualiza√ß√µes preliminares</span>
                    (<span style="color: red; font-weight: bold;">Quick Look</span>), utilizadas apenas para verificar a localiza√ß√£o da √°rea e a
                    presen√ßa de nuvens. Elas <span style="color: red; font-weight: bold;">n√£o representam a qualidade final da imagem que ser√° entregue</span>.</p>
                `;

                // Logo da Engesat
                const engesatLogoUrl = "https://www.engesat.com.br/wp-content/uploads/2024/12/engesat-logomarca.png";


                const htmlContent = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <img src="${engesatLogoUrl}" alt="Logo Engesat" style="max-width: 120px; height: auto; border-radius: 8px; display: block; margin: 0 auto 10px auto;">
                        <h1 style="font-size: 2.5em; font-weight: bold; margin-bottom: 5px;">Proposta Comercial</h1>
                        <p style="margin-top: 10px;">Curitiba, ${dataProposta}</p>
                    </div>

                    <div style="margin-bottom: 24px; padding: 16px; border-radius: 8px; background-color: #f9fafb; border: 1px solid #e5e7eb;">
                        <h3 style="font-size: 1.125em; font-weight: 600; color: #1f2937; margin-bottom: 12px;">Dados do Cliente</h3>
                        <p style="margin-bottom: 4px;"><strong>Empresa:</strong> ${empresaCliente}</p>
                        <p style="margin-bottom: 4px;"><strong>Contato:</strong> ${contatoCliente}</p>
                        <p style="margin-bottom: 4px;"><strong>CPF/CNPJ:</strong> ${cpfCliente}</p>
                        <p style="margin-bottom: 4px;"><strong>Endere√ßo:</strong> ${enderecoCliente}</p>
                        <p style="margin-bottom: 4px;"><strong>Processo Vinculado:</strong> ${processoVinculado}</p>
                    </div>

                    <p style="margin-bottom: 16px;">As ilustra√ß√µes aqui apresentadas s√£o <span style="color: red; font-weight: bold;">somente pr√©vias</span>, tamb√©m
                    chamadas de <span style="color: red; font-weight: bold;">Quick Look</span>, usadas para conferir a localiza√ß√£o e eventual presen√ßa de nuvens e <span style="color: red; font-weight: bold;">n√£o retratam a qualidade final da imagem entregue</span>.</p>
                    <p style="margin-bottom: 16px;"><strong>Link para acesso de amostras reais dos sat√©lites:</strong> <a href="https://www.engesat.com.br/imagem-de-satelite/" target="_blank" style="color: #2563eb; text-decoration: underline;">https://www.engesat.com.br/imagem-de-satelite/</a></p>
                    <p style="margin-bottom: 16px;">Boa tarde,</p>
                    <p style="margin-bottom: 16px;">Segue proposta para fornecimento de imagem de sat√©lite,</p>

                    <div style="margin-bottom: 24px; padding: 16px; border-radius: 8px; background-color: #f9fafb; border: 1px solid #e5e7eb;">
                        <h3 style="font-size: 1.5em; font-weight: 600; color: #1f2937; text-align: center; margin-bottom: 12px;">Detalhes da Imagem</h3>
                        <p style="margin-bottom: 4px;"><strong>Extens√£o da √Årea:</strong> ${extensaoArea} km¬≤</p>
                        ${imagesHtmlFigura1}
                        <!-- Sugest√£o de quebra de p√°gina 1 -->
                        <div style="page-break-after: always;"></div>

                        <p style="margin-bottom: 16px;">Alternativas de Imagens Dispon√≠veis para a √Årea: Para datas de imageamento entre ${dataImageamentoInicio} e ${dataImageamentoFim}, recomendamos a cena ${cenaRecomendada} de ${resolucaoColorida} de resolu√ß√£o colorida de ${formattedCenaDates} como segue:</p>

                        ${imagesHtmlFigurasAlternativas}

                        ${quickLookDisclaimer}

                        ${samplesHtml}

                        <!-- For√ßar quebra de p√°gina para as se√ß√µes abaixo -->
                        <div style="page-break-before: always;"></div>

                        ${especificacoesTecnicasHtml}
                        ${detalhesPedidoHtml}

                    </div>
                    <div style="height: 20px;"></div> <!-- Blank line before this section -->
                    <div style="margin-bottom: 24px; padding: 16px; border-radius: 8px; background-color: #f9fafb; border: 1px solid #e5e7eb;">
                        <h3 style="font-size: 1.125em; font-weight: 600; color: #1f2937; margin-bottom: 12px;">Informa√ß√µes Administrativas e Banc√°rias</h3>
                        <h4 style="margin-top: 16px; margin-bottom: 8px; font-size: 1em; font-weight: 500; color: #374151;">üìÑ Dados Administrativos ‚Äì Engesat Imagens de Sat√©lite</h4>
                        <ul style="list-style-type: disc; margin-left: 20px; margin-bottom: 16px;">
                            <li style="margin-bottom: 4px;"><strong>Nome Fantasia:</strong> Engesat Imagens de Sat√©lite</li>
                            <li style="margin-bottom: 4px;"><strong>Raz√£o Social:</strong> EISAT Imagens de Sat√©lite Ltda. ‚Äì EPP</li>
                            <li style="margin-bottom: 4px;"><strong>CNPJ:</strong> 02.059.387/0001-87</li>
                            <li style="margin-bottom: 4px;"><strong>Inscri√ß√£o Estadual:</strong> ISENTO</li>
                            <li style="margin-bottom: 4px;"><strong>Inscri√ß√£o Municipal:</strong> 0701351363-2</li>
                        </ul>

                        <h4 style="margin-top: 16px; margin-bottom: 8px; font-size: 1em; font-weight: 500; color: #374151;">üí≥ Dados Banc√°rios</h4>
                        <ul style="list-style-type: disc; margin-left: 20px; margin-bottom: 16px;">
                            <li style="margin-bottom: 4px;"><strong>Banco:</strong> Banco Inter 077</li>
                            <li style="margin-bottom: 4px;"><strong>Ag√™ncia:</strong> 0001</li>
                            <li style="margin-bottom: 4px;"><strong>Conta Corrente:</strong> 43930235-8</li>
                            <li style="margin-bottom: 4px;"><strong>PIX (CNPJ):</strong> 02.059.387/0001-87</li>
                        </ul>
                    </div>

                    <p style="margin-bottom: 8px;">Espero que ajude e que seja tecnicamente e comercialmente vi√°vel para o seu projeto</p>
                    <p style="margin-bottom: 16px;">Permanecemos a sua disposi√ß√£o para maiores esclarecimentos.</p>
                    <p style="margin-bottom: 4px;">Atenciosamente,</p>
                    <p style="margin-bottom: 4px;">Laurent MARTIN,</p>
                    <p>Diretor</p>
                    <div style="text-align: center; margin-top: 20px;">
                        <img src="${engesatLogoUrl}" alt="Logo Engesat" style="width: 150px; height: auto; max-width: 150px; border-radius: 8px;">
                    </div>
                `;

                previewOutput.innerHTML = htmlContent;
                downloadDocxBtn.style.display = 'block';
            });

            document.getElementById('downloadDocxBtn').addEventListener('click', () => {
                const previewOutput = document.getElementById('previewOutput');
                if (!previewOutput || !previewOutput.innerHTML.trim()) {
                    showCustomAlert('Gere a pr√©-visualiza√ß√£o antes de baixar o .docx.');
                    return;
                }

                // Get the filename from the input field
                const filename = document.getElementById('docxFilename').value.trim();
                if (!filename) {
                    showCustomAlert('Por favor, insira um nome para o arquivo DOCX.');
                    return;
                }

                // Verifica se htmlDocx est√° definido antes de usar
                if (typeof htmlDocx === 'undefined') {
                    console.error('Erro: html-docx-js n√£o est√° carregado ou acess√≠vel.');
                    showCustomAlert('Erro ao tentar baixar o .docx. Por favor, tente novamente ou contacte o suporte.');
                    return;
                }

                const content = `
                    <html xmlns:o="urn:schemas-microsoft-com:office:office"
                          xmlns:w="urn:schemas-microsoft-com:office:word"
                          xmlns="http://www.w3.org/TR/REC-html40">\
                    <head><meta charset="utf-8"></head>
                    <body>${previewOutput.innerHTML}</body>
                    </html>
                `;

                const blob = htmlDocx.asBlob(content, {
                    orientation: 'portrait',
                    margins: { top: 720, right: 720, bottom: 720, left: 720 }
                });

                saveAs(blob, filename + '.docx');
                showCustomAlert('Arquivo .docx gerado e pronto para download!');
            });
        };
    </script>
</body>
</html>
